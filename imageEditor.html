<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1158797123946133"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Image Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f0ff',
                            100: '#e6e5ff',
                            200: '#cccbff',
                            300: '#b3b2ff',
                            400: '#9998ff',
                            500: '#7f7eff',
                            600: '#6665de',
                            700: '#5D5CDE',
                            800: '#3333a3',
                            900: '#1a1a51',
                        }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .tool-btn {
            @apply w-full flex items-center justify-center p-2 rounded-lg transition-all duration-300 hover:bg-primary-100 dark:hover:bg-primary-900;
        }
        
        .tool-btn.active {
            @apply bg-primary-200 dark:bg-primary-800;
        }
        
        .slider-thumb {
            @apply appearance-none w-4 h-4 rounded-full bg-primary-700 cursor-pointer transition-all duration-200;
        }
        
        .slider-track {
            @apply appearance-none h-2 rounded-lg bg-gray-200 dark:bg-gray-700;
        }
        
        input[type=range] {
            @apply slider-track;
        }
        
        input[type=range]::-webkit-slider-thumb {
            @apply slider-thumb;
        }
        
        input[type=range]::-moz-range-thumb {
            @apply slider-thumb;
        }
        
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        
        .color-swatch {
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }
        
        .filter-preview {
            width: 70px;
            height: 70px;
            background-size: cover;
            background-position: center;
            margin: 0 auto;
            border-radius: 8px;
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .filter-preview:hover {
            transform: scale(1.1);
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        canvas {
            touch-action: none;
        }
        
        .icon-animate {
            transition: transform 0.3s ease;
        }
        
        .icon-animate:hover {
            transform: translateY(-3px);
        }
        
        .panel-transition {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Dark mode colors for icons */
        .dark .color-icon {
            filter: invert(1);
        }

        .floating-ui {
            animation: float 3s ease-in-out infinite;
        }

        .shake-animation {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .pulse-element {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-300">
    <!-- Check for dark mode -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-6">
        <!-- Header Section -->
        <header class="mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 via-primary-600 to-blue-600 text-transparent bg-clip-text animate-pulse-slow mb-4 md:mb-0">
                    <i class="fas fa-paint-brush mr-2 floating-ui"></i> আকর্ষণীয় ইমেজ এডিটর
                </h1>
                <div class="flex space-x-3">
                    <button id="upload-btn" class="bg-primary-700 hover:bg-primary-800 text-white font-medium py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center">
                        <i class="fas fa-upload mr-2 icon-animate"></i> ইমেজ আপলোড
                    </button>
                    <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center">
                        <i class="fas fa-save mr-2 icon-animate"></i> সেভ করুন
                    </button>
                    <input type="file" id="file-input" accept="image/*" class="hidden">
                </div>
            </div>
        </header>

        <!-- Main Content Section -->
        <main class="flex flex-col lg:flex-row gap-4">
            <!-- Toolbox Panel -->
            <div class="lg:w-64 bg-gray-100 dark:bg-gray-800 rounded-xl p-4 shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-center bg-gradient-to-r from-primary-600 to-purple-600 text-transparent bg-clip-text">এডিটিং টুলস</h2>
                
                <!-- Tool Buttons -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button data-tool="brush" class="tool-btn">
                        <i class="fas fa-paint-brush text-primary-700 dark:text-primary-400"></i>
                    </button>
                    <button data-tool="eraser" class="tool-btn">
                        <i class="fas fa-eraser text-primary-700 dark:text-primary-400"></i>
                    </button>
                    <button data-tool="text" class="tool-btn">
                        <i class="fas fa-font text-primary-700 dark:text-primary-400"></i>
                    </button>
                    <button data-tool="shape" class="tool-btn">
                        <i class="fas fa-shapes text-primary-700 dark:text-primary-400"></i>
                    </button>
                    <button data-tool="crop" class="tool-btn">
                        <i class="fas fa-crop-alt text-primary-700 dark:text-primary-400"></i>
                    </button>
                    <button data-tool="rotate" class="tool-btn">
                        <i class="fas fa-redo text-primary-700 dark:text-primary-400"></i>
                    </button>
                    <button data-tool="filter" class="tool-btn">
                        <i class="fas fa-magic text-primary-700 dark:text-primary-400"></i>
                    </button>
                    <button data-tool="adjust" class="tool-btn">
                        <i class="fas fa-sliders-h text-primary-700 dark:text-primary-400"></i>
                    </button>
                </div>

                <!-- Brush Size -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">ব্রাশ সাইজ</label>
                    <input type="range" id="brush-size" min="1" max="50" value="5" class="w-full">
                    <div class="flex justify-between text-xs mt-1">
                        <span>ছোট</span>
                        <span>বড়</span>
                    </div>
                </div>

                <!-- Color Picker -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">রঙ</label>
                    <div class="flex items-center space-x-2">
                        <input type="color" id="color-picker" value="#000000" class="w-10 h-10 rounded cursor-pointer border-0">
                        <div class="color-palette flex-1">
                            <div class="color-swatch" style="background-color: #ff0000"></div>
                            <div class="color-swatch" style="background-color: #00ff00"></div>
                            <div class="color-swatch" style="background-color: #0000ff"></div>
                            <div class="color-swatch" style="background-color: #ffff00"></div>
                            <div class="color-swatch" style="background-color: #ff00ff"></div>
                            <div class="color-swatch" style="background-color: #00ffff"></div>
                        </div>
                    </div>
                </div>

                <!-- Tool-specific options (will be dynamically shown) -->
                <div id="tool-options" class="hidden mt-4 p-3 bg-white dark:bg-gray-700 rounded-lg">
                    <!-- Options will be inserted here -->
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="flex-1 bg-gray-200 dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center relative min-h-[400px] shadow-lg">
                <div id="canvas-container" class="relative w-full h-full flex items-center justify-center">
                    <div id="upload-placeholder" class="text-center p-8 animate-float">
                        <i class="fas fa-cloud-upload-alt text-6xl text-primary-500 mb-4"></i>
                        <p class="text-xl font-medium">ইমেজ আপলোড করুন শুরু করার জন্য</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">JPG, PNG, ও GIF সাপোর্টেড</p>
                        <button id="mobile-upload-btn" class="mt-4 bg-primary-700 hover:bg-primary-800 text-white font-medium py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                            <i class="fas fa-upload mr-2"></i> ইমেজ আপলোড
                        </button>
                    </div>
                    <canvas id="canvas" class="hidden max-w-full max-h-full object-contain rounded shadow-xl"></canvas>
                    <div id="loading-indicator" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-lg">
                        <div class="text-white text-center">
                            <i class="fas fa-circle-notch loading-spinner text-3xl mb-2"></i>
                            <p>প্রসেসিং...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adjustment Panel -->
            <div class="lg:w-64 bg-gray-100 dark:bg-gray-800 rounded-xl p-4 shadow-lg hidden lg:block" id="adjustment-panel">
                <h2 class="text-xl font-semibold mb-4 text-center bg-gradient-to-r from-blue-600 to-primary-600 text-transparent bg-clip-text">এডজাস্টমেন্টস</h2>
                
                <!-- Brightness -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">ব্রাইটনেস</label>
                    <input type="range" id="brightness" min="-100" max="100" value="0" class="w-full">
                </div>
                
                <!-- Contrast -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">কনট্রাস্ট</label>
                    <input type="range" id="contrast" min="-100" max="100" value="0" class="w-full">
                </div>
                
                <!-- Saturation -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">স্যাচুরেশন</label>
                    <input type="range" id="saturation" min="-100" max="100" value="0" class="w-full">
                </div>
                
                <!-- Blur -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">ব্লার</label>
                    <input type="range" id="blur" min="0" max="10" value="0" step="0.1" class="w-full">
                </div>

                <!-- Filters -->
                <div>
                    <label class="block text-sm font-medium mb-2">ফিল্টারস</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="text-center">
                            <div class="filter-preview" data-filter="none">
                                <div class="text-xs mt-1">নরমাল</div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="filter-preview" data-filter="grayscale">
                                <div class="text-xs mt-1">গ্রেস্কেল</div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="filter-preview" data-filter="sepia">
                                <div class="text-xs mt-1">সেপিয়া</div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="filter-preview" data-filter="invert">
                                <div class="text-xs mt-1">ইনভার্ট</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reset button -->
                <button id="reset-adjustments" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-undo mr-2"></i> রিসেট
                </button>
            </div>
        </main>

        <!-- History Timeline -->
        <div class="mt-6 bg-gray-100 dark:bg-gray-800 rounded-xl p-4 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-history mr-2 text-primary-700 dark:text-primary-400"></i> হিস্টোরি
            </h2>
            <div class="flex space-x-2 overflow-x-auto pb-2" id="history-timeline">
                <div class="min-w-[100px] h-16 bg-gray-200 dark:bg-gray-700 rounded flex items-center justify-center text-center p-2 text-sm">
                    অরিজিনাল
                </div>
                <!-- History items will be added here -->
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-sm text-gray-500 dark:text-gray-400">
            <p>এডিট করা ইমেজ সেভ করার জন্য, ডান ক্লিক করে "Save image as..." অপশন ব্যবহার করুন</p>
            <p class="mt-2">© 2025 Ridoy Khan</p>
        </footer>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-primary-700 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
        অপারেশন সম্পন্ন হয়েছে!
    </div>

    <!-- Main JavaScript -->
    <script>
        // Global variables
        let canvas = document.getElementById('canvas');
        let ctx = null;
        let isDrawing = false;
        let activeTool = 'brush';
        let lastX = 0;
        let lastY = 0;
        let brushSize = 5;
        let brushColor = '#000000';
        let originalImage = null;
        let undoStack = [];
        let redoStack = [];
        let filters = {
            brightness: 0,
            contrast: 0,
            saturation: 0,
            blur: 0,
            currentFilter: 'none'
        };

        // Initialize the application
        function init() {
            // Set up button event listeners
            document.getElementById('upload-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            
            document.getElementById('mobile-upload-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            
            document.getElementById('file-input').addEventListener('change', handleImageUpload);
            
            document.getElementById('save-btn').addEventListener('click', saveImage);
            
            document.getElementById('brush-size').addEventListener('input', (e) => {
                brushSize = parseInt(e.target.value);
            });
            
            document.getElementById('color-picker').addEventListener('input', (e) => {
                brushColor = e.target.value;
            });
            
            // Set up tool buttons
            document.querySelectorAll('.tool-btn').forEach(button => {
                button.addEventListener('click', () => {
                    activeTool = button.dataset.tool;
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    updateToolOptions();
                });
            });
            
            // Set up color swatches
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    brushColor = getComputedStyle(swatch).backgroundColor;
                    document.getElementById('color-picker').value = rgbToHex(brushColor);
                });
            });
            
            // Set up adjustment sliders
            ['brightness', 'contrast', 'saturation', 'blur'].forEach(adjustment => {
                document.getElementById(adjustment).addEventListener('input', (e) => {
                    filters[adjustment] = parseFloat(e.target.value);
                    applyFilters();
                });
            });
            
            // Setup filter previews
            document.querySelectorAll('.filter-preview').forEach(preview => {
                preview.addEventListener('click', () => {
                    filters.currentFilter = preview.dataset.filter;
                    applyFilters();
                });
            });
            
            // Reset button
            document.getElementById('reset-adjustments').addEventListener('click', resetAdjustments);
            
            // Add canvas event listeners once an image is loaded
        }

        // Handle image upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            // Show loading indicator
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Hide upload placeholder
                    document.getElementById('upload-placeholder').classList.add('hidden');
                    
                    // Show canvas
                    canvas.classList.remove('hidden');
                    
                    // Reset canvas and context
                    setupCanvas(img);
                    
                    // Store original image
                    originalImage = img;
                    
                    // Reset filters
                    resetAdjustments();
                    
                    // Reset history
                    undoStack = [];
                    redoStack = [];
                    
                    // Add event listeners to canvas
                    setupCanvasListeners();
                    
                    // Hide loading indicator
                    document.getElementById('loading-indicator').classList.add('hidden');
                    
                    // Show notification
                    showToast('ইমেজ সফলভাবে লোড হয়েছে!');
                    
                    // Set up filter previews with the actual image
                    setupFilterPreviews(img);
                    
                    // Save initial state
                    saveState();
                };
                img.src = event.target.result;
            };
            
            reader.readAsDataURL(file);
        }

        // Set up canvas based on image dimensions
        function setupCanvas(img) {
            const container = document.getElementById('canvas-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            let canvasWidth = img.width;
            let canvasHeight = img.height;
            
            // Scale down if the image is too large
            const maxWidth = containerWidth * 0.9;
            const maxHeight = containerHeight * 0.9;
            
            if (canvasWidth > maxWidth || canvasHeight > maxHeight) {
                const ratio = Math.min(maxWidth / canvasWidth, maxHeight / canvasHeight);
                canvasWidth = canvasWidth * ratio;
                canvasHeight = canvasHeight * ratio;
            }
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            ctx = canvas.getContext('2d');
            
            // Draw image on canvas
            ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
            
            // Add a subtle animation
            canvas.classList.add('shake-animation');
            setTimeout(() => {
                canvas.classList.remove('shake-animation');
            }, 820);
        }

        // Set up event listeners for canvas drawing
        function setupCanvasListeners() {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        // Handle touch events
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        // Start drawing
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [
                e.clientX - canvas.getBoundingClientRect().left,
                e.clientY - canvas.getBoundingClientRect().top
            ];
            
            // For some tools, we want to capture the state before drawing
            if (['brush', 'eraser'].includes(activeTool)) {
                saveState();
            }
        }

        // Draw on canvas
        function draw(e) {
            if (!isDrawing) return;
            
            const x = e.clientX - canvas.getBoundingClientRect().left;
            const y = e.clientY - canvas.getBoundingClientRect().top;
            
            if (activeTool === 'brush') {
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.strokeStyle = brushColor;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
            } else if (activeTool === 'eraser') {
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.globalCompositeOperation = 'destination-out';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                ctx.globalCompositeOperation = 'source-over';
            }
            
            [lastX, lastY] = [x, y];
        }

        // Stop drawing
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveState();
            }
        }

        // Apply all filters to the canvas
        function applyFilters() {
            if (!originalImage) return;
            
            // Reset canvas to original image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
            
            // Apply filters
            if (filters.brightness !== 0 || filters.contrast !== 0 || filters.saturation !== 0 || filters.blur !== 0 || filters.currentFilter !== 'none') {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Apply brightness, contrast, saturation
                for (let i = 0; i < data.length; i += 4) {
                    // Apply brightness
                    data[i] = clamp(data[i] + filters.brightness * 2.55);
                    data[i + 1] = clamp(data[i + 1] + filters.brightness * 2.55);
                    data[i + 2] = clamp(data[i + 2] + filters.brightness * 2.55);
                    
                    // Apply contrast
                    const factor = (259 * (filters.contrast + 255)) / (255 * (259 - filters.contrast));
                    data[i] = clamp(factor * (data[i] - 128) + 128);
                    data[i + 1] = clamp(factor * (data[i + 1] - 128) + 128);
                    data[i + 2] = clamp(factor * (data[i + 2] - 128) + 128);
                    
                    // Apply current filter
                    if (filters.currentFilter === 'grayscale') {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = avg;
                        data[i + 1] = avg;
                        data[i + 2] = avg;
                    } else if (filters.currentFilter === 'sepia') {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        data[i] = clamp(r * 0.393 + g * 0.769 + b * 0.189);
                        data[i + 1] = clamp(r * 0.349 + g * 0.686 + b * 0.168);
                        data[i + 2] = clamp(r * 0.272 + g * 0.534 + b * 0.131);
                    } else if (filters.currentFilter === 'invert') {
                        data[i] = 255 - data[i];
                        data[i + 1] = 255 - data[i + 1];
                        data[i + 2] = 255 - data[i + 2];
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                // Apply blur (we apply this last to avoid iterating through pixels again)
                if (filters.blur > 0) {
                    // This is a simple implementation, real blur would use convolution
                    ctx.filter = `blur(${filters.blur}px)`;
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                }
            }
            
            saveState();
        }

        // Reset all adjustments
        function resetAdjustments() {
            filters = {
                brightness: 0,
                contrast: 0,
                saturation: 0,
                blur: 0,
                currentFilter: 'none'
            };
            
            // Reset all slider values
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 0;
            document.getElementById('saturation').value = 0;
            document.getElementById('blur').value = 0;
            
            if (originalImage) {
                applyFilters();
                showToast('ফিল্টার রিসেট করা হয়েছে!');
            }
        }

        // Save current canvas state to history
        function saveState() {
            if (ctx) {
                undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
                redoStack = [];
                updateHistoryPanel();
            }
        }

        // Update history panel
        function updateHistoryPanel() {
            const timeline = document.getElementById('history-timeline');
            
            // Clear existing history items (except the original)
            const children = Array.from(timeline.children);
            for (let i = 1; i < children.length; i++) {
                timeline.removeChild(children[i]);
            }
            
            // Add undo stack items
            for (let i = 0; i < undoStack.length; i++) {
                const item = document.createElement('div');
                item.className = 'min-w-[100px] h-16 bg-primary-100 dark:bg-primary-900 rounded flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-primary-200 dark:hover:bg-primary-800 text-sm';
                item.textContent = `এডিট ${i + 1}`;
                item.dataset.index = i;
                item.addEventListener('click', () => {
                    // Go to that state
                    for (let j = undoStack.length - 1; j > i; j--) {
                        redoStack.push(undoStack.pop());
                    }
                    ctx.putImageData(undoStack[i], 0, 0);
                    updateHistoryPanel();
                });
                timeline.appendChild(item);
            }
        }

        // Save image
        function saveImage() {
            if (!canvas) return;
            
            // Show toast with instructions
            showToast('ইমেজ সেভ করতে ডান ক্লিক করুন ও "Save image as..." নির্বাচন করুন');
            
            // Highlight the canvas with animation
            canvas.classList.add('shake-animation');
            setTimeout(() => {
                canvas.classList.remove('shake-animation');
            }, 820);
        }

        // Setup filter previews with the actual image
        function setupFilterPreviews(img) {
            const previews = document.querySelectorAll('.filter-preview');
            
            previews.forEach(preview => {
                const previewCanvas = document.createElement('canvas');
                previewCanvas.width = 70;
                previewCanvas.height = 70;
                const previewCtx = previewCanvas.getContext('2d');
                
                // Draw scaled version of original image
                const aspectRatio = img.width / img.height;
                let drawWidth, drawHeight, drawX, drawY;
                
                if (aspectRatio > 1) {
                    drawHeight = 70;
                    drawWidth = 70 * aspectRatio;
                    drawX = (70 - drawWidth) / 2;
                    drawY = 0;
                } else {
                    drawWidth = 70;
                    drawHeight = 70 / aspectRatio;
                    drawX = 0;
                    drawY = (70 - drawHeight) / 2;
                }
                
                previewCtx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                
                // Apply filter
                const filter = preview.dataset.filter;
                if (filter === 'grayscale') {
                    const imageData = previewCtx.getImageData(0, 0, 70, 70);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = avg;
                        data[i + 1] = avg;
                        data[i + 2] = avg;
                    }
                    previewCtx.putImageData(imageData, 0, 0);
                } else if (filter === 'sepia') {
                    const imageData = previewCtx.getImageData(0, 0, 70, 70);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        data[i] = clamp(r * 0.393 + g * 0.769 + b * 0.189);
                        data[i + 1] = clamp(r * 0.349 + g * 0.686 + b * 0.168);
                        data[i + 2] = clamp(r * 0.272 + g * 0.534 + b * 0.131);
                    }
                    previewCtx.putImageData(imageData, 0, 0);
                } else if (filter === 'invert') {
                    const imageData = previewCtx.getImageData(0, 0, 70, 70);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i + 1] = 255 - data[i + 1];
                        data[i + 2] = 255 - data[i + 2];
                    }
                    previewCtx.putImageData(imageData, 0, 0);
                }
                
                // Set preview background
                preview.style.backgroundImage = `url(${previewCanvas.toDataURL()})`;
            });
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Update tool options based on selected tool
        function updateToolOptions() {
            const toolOptions = document.getElementById('tool-options');
            toolOptions.innerHTML = '';
            
            if (activeTool === 'text') {
                toolOptions.classList.remove('hidden');
                toolOptions.innerHTML = `
                    <div>
                        <label class="block text-sm font-medium mb-1">টেক্সট</label>
                        <input type="text" id="text-input" class="w-full p-2 border rounded-lg text-base" placeholder="আপনার টেক্সট লিখুন...">
                        <button id="add-text-btn" class="mt-2 w-full bg-primary-700 hover:bg-primary-800 text-white font-medium py-1 px-2 rounded-lg transition duration-300 ease-in-out">
                            যোগ করুন
                        </button>
                    </div>
                `;
                
                // Add event listener
                document.getElementById('add-text-btn').addEventListener('click', addText);
            } else if (activeTool === 'shape') {
                toolOptions.classList.remove('hidden');
                toolOptions.innerHTML = `
                    <div>
                        <label class="block text-sm font-medium mb-1">শেপ</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button data-shape="rectangle" class="shape-btn p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                                <div class="w-full h-6 border-2 border-primary-700 dark:border-primary-400"></div>
                            </button>
                            <button data-shape="circle" class="shape-btn p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                                <div class="w-6 h-6 mx-auto rounded-full border-2 border-primary-700 dark:border-primary-400"></div>
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                document.querySelectorAll('.shape-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        addShape(btn.dataset.shape);
                    });
                });
            } else if (activeTool === 'crop') {
                toolOptions.classList.remove('hidden');
                toolOptions.innerHTML = `
                    <div>
                        <p class="text-sm mb-2">কাটার সাইজ নির্ধারণ করুন:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button data-ratio="1:1" class="crop-btn p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                                1:1 (বর্গাকার)
                            </button>
                            <button data-ratio="4:3" class="crop-btn p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                                4:3
                            </button>
                            <button data-ratio="16:9" class="crop-btn p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                                16:9
                            </button>
                            <button data-ratio="free" class="crop-btn p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                                ফ্রি-ফর্ম
                            </button>
                        </div>
                    </div>
                `;
            } else if (activeTool === 'rotate') {
                toolOptions.classList.remove('hidden');
                toolOptions.innerHTML = `
                    <div>
                        <div class="flex justify-between">
                            <button id="rotate-left" class="p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                                <i class="fas fa-undo text-primary-700 dark:text-primary-400"></i> 90° বামে
                            </button>
                            <button id="rotate-right" class="p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                                <i class="fas fa-redo text-primary-700 dark:text-primary-400"></i> 90° ডানে
                            </button>
                        </div>
                        <button id="flip-horizontal" class="mt-2 w-full p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                            <i class="fas fa-arrows-alt-h text-primary-700 dark:text-primary-400"></i> আড়াআড়ি ফ্লিপ
                        </button>
                        <button id="flip-vertical" class="mt-2 w-full p-2 bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition duration-300">
                            <i class="fas fa-arrows-alt-v text-primary-700 dark:text-primary-400"></i> লম্বালম্বি ফ্লিপ
                        </button>
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('rotate-left').addEventListener('click', () => rotateImage(-90));
                document.getElementById('rotate-right').addEventListener('click', () => rotateImage(90));
                document.getElementById('flip-horizontal').addEventListener('click', () => flipImage('horizontal'));
                document.getElementById('flip-vertical').addEventListener('click', () => flipImage('vertical'));
            } else {
                toolOptions.classList.add('hidden');
            }
        }

        // Add text to canvas
        function addText() {
            if (!ctx) return;
            
            const textInput = document.getElementById('text-input');
            const text = textInput.value.trim();
            
            if (text === '') {
                showToast('দয়া করে টেক্সট লিখুন!');
                return;
            }
            
            saveState();
            
            // Add text at center of canvas
            ctx.font = `${brushSize * 2}px Arial`;
            ctx.fillStyle = brushColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            
            textInput.value = '';
            showToast('টেক্সট যোগ করা হয়েছে!');
            saveState();
        }

        // Add shape to canvas
        function addShape(shape) {
            if (!ctx) return;
            
            saveState();
            
            // Add shape to center of canvas
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const size = Math.min(canvas.width, canvas.height) / 4;
            
            ctx.fillStyle = brushColor;
            
            if (shape === 'rectangle') {
                ctx.fillRect(centerX - size/2, centerY - size/2, size, size);
            } else if (shape === 'circle') {
                ctx.beginPath();
                ctx.arc(centerX, centerY, size/2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            showToast('শেপ যোগ করা হয়েছে!');
            saveState();
        }

        // Rotate image
        function rotateImage(degrees) {
            if (!ctx) return;
            
            saveState();
            
            // Create temporary canvas
            const tempCanvas = document.createElement('canvas');
            let tempCtx = tempCanvas.getContext('2d');
            
            // In case of 90 or 270 degrees, switch width and height
            if (Math.abs(degrees) === 90 || Math.abs(degrees) === 270) {
                tempCanvas.width = canvas.height;
                tempCanvas.height = canvas.width;
            } else {
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
            }
            
            // Translate and rotate
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate(degrees * Math.PI / 180);
            
            // Draw the original canvas onto the temp canvas
            tempCtx.drawImage(
                canvas, 
                -canvas.width / 2, 
                -canvas.height / 2
            );
            
            // Clear and resize original canvas
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            
            // Draw rotated image back to original canvas
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ইমেজ ঘোরানো হয়েছে!');
            saveState();
        }

        // Flip image horizontally or vertically
        function flipImage(direction) {
            if (!ctx) return;
            
            saveState();
            
            // Create temporary canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Draw original canvas to temp
            tempCtx.drawImage(canvas, 0, 0);
            
            // Clear original canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Flip horizontally
            if (direction === 'horizontal') {
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(tempCanvas, 0, 0);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
            } 
            // Flip vertically
            else if (direction === 'vertical') {
                ctx.translate(0, canvas.height);
                ctx.scale(1, -1);
                ctx.drawImage(tempCanvas, 0, 0);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
            }
            
            showToast('ইমেজ ফ্লিপ করা হয়েছে!');
            saveState();
        }

        // Utility function: Clamp value between 0 and 255
        function clamp(value) {
            return Math.max(0, Math.min(255, value));
        }

        // Utility function: Convert RGB to Hex
        function rgbToHex(rgb) {
            // Extract r, g, b values from rgb(r, g, b) format
            const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!match) return '#000000';
            
            function hex(x) {
                return ("0" + parseInt(x).toString(16)).slice(-2);
            }
            
            return "#" + hex(match[1]) + hex(match[2]) + hex(match[3]);
        }

        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
